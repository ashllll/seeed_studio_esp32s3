# ESP32-S3 智能温控系统

基于Seeed Studio XIAO ESP32-S3开发板的精密温控系统，采用ADS1115高精度ADC读取NTC100K温度传感器，通过PID算法控制PTC加热器功率，并使用SSD1306 OLED显示屏和旋转编码器实现人机交互。

ntc100k接线：
 VCC --- NTC电阻 --- 分压点 --- 固定电阻 --- GND

## 功能特点

- 高精度温度控制：±0.5°C控制精度
- 多级菜单UI系统：直观导航和参数调整界面
- 实时数据显示：温度、功率百分比和系统状态
- 编码器交互：旋转调节、单击/双击/长按实现不同功能
- 增强型错误检测：传感器断开、短路、ADC异常监测
- 温度变化率保护：监控温度变化速率，防止温度失控
- 自适应PID控制：完整的参数自整定功能
- 优化的UI体验：导航面包屑和自适应刷新率

## 硬件配置

- 主控板：Seeed Studio XIAO ESP32-S3
- 温度传感器：NTC100K + 100K分压电阻
- 模拟信号采集：ADS1115 16位ADC
- 显示屏：SSD1306 OLED (128x64)
- 加热元件：12V PTC加热器
- 功率控制：通过MOS管进行PWM调制
- 用户输入：旋转编码器(带按钮)

## 软件架构

系统采用多级UI驱动设计，主要包含以下模块：

- 温度采集模块：ADS1115采集 + 数据滤波
- PID控制模块：动态计算PWM输出，自动整定支持
- PWM输出模块：LEDC控制MOS管输出
- UI适配器模块：多级菜单和页面管理
- 用户输入模块：编码器信号处理
- 错误检测模块：多种错误状态监测与处理
- 安全保护模块：温度变化率监控与保护
- 参数存储模块：EEPROM数据管理
- 网络接口预留：支持后续功能扩展

详细系统流程参见 [system_flow_chart.md](system_flow_chart.md)

## UI界面结构

系统UI界面分为多个层级：

1. **主页面**：显示当前温度、目标温度、功率百分比、温度变化率和系统状态
2. **主菜单**：包含PID参数、校准、系统信息等子菜单
3. **PID参数菜单**：调整Kp、Ki、Kd值，保存参数或执行自动调整
4. **自整定页面**：执行PID参数自动整定，显示进度和结果
5. **校准页面**：设置温度偏移量，校准测量值
6. **系统信息页面**：显示版本、运行时间和PID参数
7. **错误页面**：显示详细错误信息和处理建议

## 菜单项类型

支持四种菜单项类型：

- **普通菜单项**：执行简单操作
- **开关菜单项**：切换ON/OFF状态
- **滑块菜单项**：调整数值参数
- **子菜单项**：导航到下一级菜单

## 增强的错误检测

系统实现了全面的错误检测机制：

1. **传感器开路检测**：监测NTC100K传感器是否断开连接
2. **传感器短路检测**：监测NTC100K传感器是否短路
3. **ADC读取异常检测**：监测ADS1115读数是否在合理范围内
4. **温度变化率异常检测**：监测温度是否上升或下降过快

## 安全保护机制

为确保系统安全，实现了多重保护措施：

1. **过温保护**：温度超过安全阈值时立即关闭输出
2. **温度变化率保护**：当温度变化过快时限制输出功率
3. **传感器异常保护**：检测到传感器问题时进入安全状态
4. **自动恢复机制**：轻微错误可自动恢复，严重错误需手动重置

## 主要改进

最新版本相比初始设计的关键改进：

1. **多级UI系统**：重新设计了UI系统，使用更直观的多级菜单结构
2. **增强错误检测**：添加了全面的错误检测机制，提高系统可靠性
3. **温度变化率监控**：实时监测温度变化速度，防止加热失控
4. **优化的PID自整定**：集成完整的参数自动调整算法
5. **UI导航优化**：添加导航面包屑和增强视觉提示
6. **自适应刷新率**：根据不同页面需求优化UI刷新速度
7. **网络功能预留**：为后续功能扩展预留接口

## 主要修改点
- 检查并完善了 NTC 分压电路 (VCC --- NTC --- 分压点 --- 固定电阻 --- GND)，已验证正常工作
- 接口设定说明：分压点连接至 ADS1115 的 A0 接口，用于读取 NTC 分压电压值

## GPIO接口定义

### I2C设备
- **SDA**: GPIO21 - 连接至ADS1115和SSD1306 OLED的SDA引脚
- **SCL**: GPIO20 - 连接至ADS1115和SSD1306 OLED的SCL引脚

### 旋转编码器
- **CLK**: GPIO5 - 连接至编码器的时钟引脚
- **DT**: GPIO6 - 连接至编码器的数据引脚
- **SW**: GPIO7 - 连接至编码器的按钮引脚

### 输出控制
- **PWM**: GPIO8 - 连接至MOS管控制PTC加热器

### 模拟输入
- **NTC**: 连接至ADS1115的A0通道
- **ADS1115地址**: 0x48

### 电源连接
- **VCC**: 3.3V供电至ADS1115、SSD1306及NTC分压电路
- **PTC加热器**: 12V外部电源

## 开发环境

- PlatformIO + Arduino框架
- 主要依赖库：
  - Adafruit_ADS1X15
  - Adafruit_SSD1306
  - PID_v1（增强版，支持自整定）
  - AiEsp32RotaryEncoder 

## 特别鸣谢

- [oled-ui-astra-lite](https://github.com/AstraThreshold/oled-ui-astra-lite.git) - 纯C语言实现的轻量级OLED/LCD UI框架，提供了广泛的屏幕兼容性和高度可定制性 